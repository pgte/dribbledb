/* dribbledb: simple syncing in javascript
 *
 * copyright 2011 pedro teixeira <metaduck.com> & nuno job <nunojob.com> (oO)--',--
 *
 * licensed under the apache license, version 2.0 (the "license");
 * you may not use this file except in compliance with the license.
 * you may obtain a copy of the license at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * unless required by applicable law or agreed to in writing, software
 * distributed under the license is distributed on an "as is" basis,
 * without warranties or conditions of any kind, either express or implied.
 * see the license for the specific language governing permissions and
 * limitations under the license.
 *
 * VERSION: 0.1.0
 * BUILD DATE: Thu Nov 24 12:14:30 2011 +0000
 */(function(){function b(){this.callbacks={}}function d(){}function e(a,b,d,e){"function"==typeof arguments[2]&&(e=d,d=undefined),c[a](b,d).type("application/javascript").expectResponseType("json").end(e)}function f(a,b){e("get",a,undefined,b)}function g(a,b){return o+":"+b+":"+a}function h(a,b,c){return c!==undefined&&(a+="/"+c),g(a,b)}function i(a,b){return h(a,"d",b)}function j(a,b){return h(a,"m",b)}function k(a){return h(a,"s")}function p(a,c){function g(a){return function(b){function d(a){return i(b,a)}function e(a){return j(b,a)}function f(){return k(b)}function g(a){return c.get(d(a))}function h(a,b){return c.put(d(a),b)}function l(a){return c.destroy(d(a))}function m(a){return c.get(e(a))}function n(a,b){return c.put(e(a),b)}function o(a){return c.destroy(e(a))}function p(a,b){return c.all_keys_iterator(d(),a,b)}function q(){return c.all_keys(d())}function r(){return c.all_keys(e())}function s(a){var b=f();return a?angine.put(b,a):c.get(b)||0}var c=a();return{doc_get:g,doc_put:h,doc_destroy:l,meta_get:m,meta_put:n,meta_destroy:o,all_doc_keys_iterator:p,all_doc_keys:q,all_meta_keys:r,pulled_since:s}}}function h(a){var b={localstore:o,sessionstore:p,memstore:q};return g(b[a])}function n(a,b,c){function e(a){var c=b.getItem(a);return JSON.parse(c)}function f(a,c){c=JSON.stringify(c),b.setItem(a,c)}function g(a){return null!==b.getItem(a)?(b.removeItem(a),!0):!1}function h(a,c,f){var g=b,h,i=0;f=f||d,h=function(){var b,c,d=[];for(c=0;c<g.length;c++)b=g.key(c),b&&0===b.indexOf(a)&&d.push(b);return d}(),function j(){function d(){i++,j()}var b;if(i<h.length)b=h[i],c(b.slice(a.length+1),e(b),d);else return f()}()}function i(a){var b=[];return h(a,function(a,c,d){b.push(a),d()}),b}if(!b)throw new Error("At the moment this only works in modern browsers");return{get:e,put:f,destroy:g,all_keys_iterator:h,all_keys:i,stratName:c}}function o(a){return n(a,m.localStorage,"localstore")}function p(a){return n(a,m.sessionStorage,"sessionstore")}function q(a){function c(a){return JSON.parse(JSON.stringify(a))}function e(a){var d=b[a];return"undefined"!=typeof d?c(d):null}function f(a,d){b[a]=c(d)}function g(a){delete b[a]}function h(a,c,f){var g=b,h,i=0;f=f||d,h=function(){var c,d=[];for(c in b)c&&0===c.indexOf(a)&&d.push(c);return d}(),function j(){function d(){i++,j()}var b;if(i<h.length)b=h[i],c(b.slice(a.length+1),e(b),d);else return f()}()}function i(a){var b=[];return h(a,function(a,c,d){b.push(a),d()}),b}var b={};return{get:e,put:f,destroy:g,all_keys_iterator:h,all_keys:i,stratName:"memstore"}}function r(a){var b;if("function"==typeof a)b=a;else switch(a){case"couchdb_bulk":b=s;break;default:throw new Error("Unknown pull strategy: "+a)}return b}function s(){var b=a+"/_changes?since="+C()+"&include_docs=true";return function(a,c){var d=!1;f(b,function(d,e){var f,g,h,i,j,k,l,m;if(d)return c(d);if(!e.ok)return c(new Error("Pull response not ok for URI: "+b));if(!e.body)return c(new Error("Pull response does not have body for URI: "+b));g=e.body;if("object"!=typeof g)return c(new Error("Pull response body is not object for URI: "+b));if(!g.hasOwnProperty("last_seq"))return l=new Error("response body does not have .last_seq: "+b),l.body=g,c(l);if(!g.hasOwnProperty("results"))return l=new Error("response body does not have .results: "+b),l.body=g,c(l);h=g.results,f=-1,function n(){f+=1;if(f<h.length){i=h[f],j=i.id,k=i.doc;if(F(meta_key(j)))if(a)m=F(doc_key(j)),a(m,k,function(a){D(j,a),n()});else return l=new Error("Conflict"),l.key=j,l.mine=m,l.theirs=k,c(l);else i.deleted?H(j):E(j,k),n()}else C(g.last_seq),c()}()})}}function t(a){var b;if("function"==typeof a)b=a;else switch(a){case"restful_ajax":b=u;break;default:throw new Error("Unknown push strategy: "+a)}return b}function u(){return function(b,c){function g(d,h,i){function o(a,e){if(a)return c(a);if(e.conflict)f(n,function(a,e){if(a)return c(a);if(b)b(m,e.body,function(a){D(d,a),g(d,h,i)});else return a=new Error("Conflict"),a.key=d,a.mine=m,a.theirs=e.body,c(a)});else{if(("del"!==j||!e.notFound)&&!e.ok)return c(new Error(j+" "+n+" failed with response status "+e.status+": "+e.text));x.destroy(meta_key(d)),i()}}var j,k=h.charAt(0),l=h.substr(1),m=F(d),n=a+"/"+d;j=k==="p"?"put":k==="d"?"del":undefined;if(!j)throw new Error("Invalid meta action: "+h);l&&(n+="?rev="+l),e(j,n,m,o)}var d=!1;B(g,c)}}function A(){return x.all_meta_keys()}function B(a,b){x.all_meta_keys_iterator(a,b)}function C(a){return x.pulled_since()}function D(a,b){arguments.length<2&&(b=a,a=b.id||b._id||l());if(!b.id||b._id)b._id=a;return x.doc_put(a,b),x.meta_put(a,"p"),a}function E(a,b){return x.doc_put(uri,b)}function F(a){return x.doc_get(a)}function G(a){var b="d",c=F(a);c&&c._rev&&(b+=c._rev),x.doc_destroy(a)&&x.meta_put(a,b)}function H(a){x.doc_destroy(a)}function I(a,b){var c;return"function"!=typeof a&&(c=[],a=function(a,b,d){c.push(b),d()}),x.all_doc_keys_iterator(a,b),c}function J(){return x.all_doc_keys().forEach(function(a){x.doc_destroy(a)}),x.all_meta_keys().forEach(function(a){x.meta_destroy(a)}),!0}function K(a,b){y(a,b)}function L(a,b){z(a,b)}var v={},w,x,y,z;return c=c||{},c.storage_strategy=c.storage_strategy||"localstore",x=h(c.storage_strategy)(a),v.storageStrategy=x.stratName,c.pull_strategy=c.pull_strategy||"couchdb_bulk",y=r(c.pull_strategy)(),c.push_strategy=c.push_strategy||"restful_ajax",z=t(c.push_strategy)(),w=function(){function c(b,c){function e(){return!d&&typeof c=="function"?(d=!0,c.apply(v,arguments),!0):!1}function f(b){return b?(e(b)||a.emit("error",b),!0):!1}var d=!1;arguments.length<2&&(c=b,b=undefined),L(b,function(a){if(a)return f(a);K(b,function(a){if(a)return f(a);e()})})}var a=new b;return c.on=function(){a.on.apply(a,arguments)},c}(),v.sync=w,v.put=D,v.get=F,v.destroy=G,v.unsynced_keys=A,v.all=I,v.nuke=J,v}var a=[].slice;b.prototype.on=function(a,b){return(this.callbacks[a]=this.callbacks[a]||[]).push(b),this},b.prototype.emit=function(b){var c=a.call(arguments,1),d=this.callbacks[b],e;if(d&&d.length>0)for(e=0,len=d.length;e<len;++e)d[e](c);else if("error"===b)throw c[0]||new Error("Unspecified error");return this};var c=function(a){function d(){if(window.XMLHttpRequest&&("file:"!==window.location.protocol||!window.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(b){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(c){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(d){}return!1}function f(a){return"function"==typeof a}function g(a){if(null===a||undefined==a)return!1;var b=a.constructor;return b&&Object===b}function h(a){var b;if(!g(a))return a;var c=[];for(b in a)a.hasOwnProperty(b)&&c.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));return c.join("&")}function i(a){var b={},c=a.split("&"),d,e,f;for(f=0,len=c.length;f<len;++f)e=c[f],d=e.split("="),b[decodeURIComponent(d[0])]=decodeURIComponent(d[1]);return b}function j(a){var b=a.split(/\r?\n/),c={},d,f,g,h,i;b.pop();for(i=0,len=b.length;i<len;++i)f=b[i],d=f.indexOf(":"),g=f.slice(0,d).toLowerCase(),h=e(f.slice(d+1)),c[g]=h;return c}function k(a,b){b=b||{},this.options=b,this.xhr=a,this.text=a.responseText,this.setStatusProperties(a.status),this.header=j(a.getAllResponseHeaders()),this.setHeaderProperties(this.header),this.body=this.parseBody(this.text)}function l(a,c){var d=this;b.call(this),this.method=a,this.url=c,this.header={},this.set("X-Requested-With","XMLHttpRequest"),this.on("end",function(){var a=new k(d.xhr,{expectResponseType:d._expectResponseType}),b;a.status===0&&(b=new Error("Unknown XHR Error")),d.callback(b,a)})}function m(a,b){return"function"==typeof b?(new l("GET",a)).end(b):1===arguments.length?new l("GET",a):new l(a,b)}a=m,a.version="0.1.1";var c=function(){},e="".trim?function(a){return a.trim()}:function(a){return a.replace(/(^\s*|\s*$)/g,"")};return a.serializeObject=h,a.parseString=i,a.types={html:"text/html",json:"application/json",urlencoded:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"},a.serialize={"application/x-www-form-urlencoded":h,"application/json":JSON.stringify},a.parse={"application/x-www-form-urlencoded":i,"application/json":JSON.parse},k.prototype.setHeaderProperties=function(a){var b=(this.header["content-type"]||"").split(/ *; */);this.contentType=b.shift(),this.setParams(b)},k.prototype.setParams=function(a){var b,c;for(c=0,len=a.length;c<len;++c)b=a[c].split(/ *= */),this[b[0]]=b[1]},k.prototype.parseBody=function(b){var c=a.parse[this.ok&&this.options.expectResponseType||this.contentType];return c?c(b):null},k.prototype.setStatusProperties=function(a){var b=a/100|0;this.status=a,this.statusType=b,this.info=1===b,this.ok=2===b,this.clientError=4===b,this.serverError=5===b,this.error=4===b||5===b,this.accepted=202===a,this.noContent=204===a||1223===a,this.badRequest=400===a,this.unauthorized=401===a,this.notFound=404===a,this.notAcceptable=406===a,this.conflict=409===a},a.Response=k,l.prototype=new b,l.prototype.constructor=l,l.prototype.set=function(a,b){var c;if(g(a)){for(c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);return this}return this.header[a.toLowerCase()]=b,this},l.prototype.expectResponseType=function(b){return this._expectResponseType=a.types[b]||b,this},l.prototype.type=function(b){return this.set("Content-Type",a.types[b]||b),this},l.prototype.data=function(a){var b=g(a),c;if(b&&g(this._data))for(c in a)a.hasOwnProperty(c)&&(this._data[c]=a[c]);else this._data=a;return"GET"===this.method?this:b?this.header["content-type"]?this:(this.type("json"),this):this},l.prototype.send=function(a,b){return f(a)?this.end(a):a?this.data(a).end(b):this.end(),this},l.prototype.end=function(b){var e=this,f=this.xhr=d(),g=this._data||null,h;this.callback=b||c,f.onreadystatechange=function(){4===f.readyState&&e.emit("end")},"GET"===this.method&&null!==g&&(this.url+="?"+a.serializeObject(g),g=null),f.open(this.method,this.url,!0);if("GET"!==this.method&&"HEAD"!==this.method){var i=a.serialize[this.header["content-type"]];i&&(g=i(g))}for(h in this.header)this.header.hasOwnProperty(h)&&f.setRequestHeader(h,this.header[h]);return f.send(g),this},a.Request=l,m.get=function(a,b,c){var d=m("GET",a);return f(b)&&(c=b,b=null),b&&d.data(b),c&&d.end(c),d},m.del=function(a,b){var c=m("DELETE",a);return b&&c.end(b),c},m.post=function(a,b,c){var d=m("POST",a);return b&&d.data(b),c&&d.end(c),d},m.put=function(a,b,c){var d=m("PUT",a);return b&&d.data(b),c&&d.end(c),d},a}({}),l=function(){function h(a){var b=new c(16),d=0;return a.toLowerCase().replace(/[0-9a-f][0-9a-f]/g,function(a){b[d++]=f[a]}),b}function i(a){var b=e,c=a;return b[c[0]]+b[c[1]]+b[c[2]]+b[c[3]]+"-"+b[c[4]]+b[c[5]]+"-"+b[c[6]]+b[c[7]]+"-"+b[c[8]]+b[c[9]]+"-"+b[c[10]]+b[c[11]]+b[c[12]]+b[c[13]]+b[c[14]]+b[c[15]]}function q(e,f,g){typeof e=="string"&&(e={format:e}),e=e||{};var h=e.format!="binary"?d:f?f:new c(16),k=f&&g||0,l=(e.timestamp!==undefined?e.timestamp:(new Date).getTime())+a;p=l===o?p+1:0,p=e.count||p;if(l<o||p>b)n++,p=0;o=l;var q=l,r=((q&268435455)*1e4+p)%4294967296,s=q/4294967296*1e4&268435455,t=s&65535,u=s>>16,v=u&4095|4096;n=e.clockseq!==undefined?e.clockseq:n;var w=n&255,x=n>>>8|128;h[k++]=r>>>24&j,h[k++]=r>>>16&j,h[k++]=r>>>8&j,h[k++]=r&j,h[k++]=t>>>8&j,h[k++]=t&j,h[k++]=v>>>8&j,h[k++]=v&j,h[k++]=x,h[k++]=w,m=e.node||m;var y=0;return h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],e.format===undefined?i(h):h}function r(a,b,e){typeof a=="string"&&(a={format:a}),a=a||{};var f=a.format!="binary"?d:b?b:new c(16),g=b&&e||0;a.random?l=a.random:k?crypto.getRandomValues(l):(l[0]=Math.random()*4294967296,l[1]=Math.random()*4294967296,l[2]=Math.random()*4294967296,l[3]=Math.random()*4294967296);var h=l[0];return f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,h=l[1],f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&15|64,f[g++]=h>>>24&j,h=l[2],f[g++]=h&63|128,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,h=l[3],f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,a.format===undefined?i(f):f}var a=122192928e5,b=1e4,c=typeof Buffer=="function"?Buffer:Array,d=new c(16),e=[],f={};for(var g=0;g<256;g++)e[g]=(g+256).toString(16).substr(1),f[e[g]]=g;var j=255,k=this.crypto&&crypto.getRandomValues,l=k?new Uint32Array(4):Array(4);k?crypto.getRandomValues(l):(l[0]=Math.random()*4294967296,l[1]=Math.random()*4294967296,l[2]=Math.random()*4294967296);var m=[l[0]&j|1,l[0]>>>8&j,l[0]>>>16&j,l[0]>>>24&j,l[1]&j,l[1]>>>8&j],n=l[2]&16383,o=0,p=0,s=r;s.v1=q,s.v4=r,s.parse=h,s.unparse=i,s.BufferClass=c;if(typeof module!="undefined")module.exports=s;else return s}().v4,m=this,n=m.dribbledb,o="dbd";p.version="0.1.0","function"==typeof define&&define.amd?define("dribbledb",function(){return p}):m.dribbledb=p,function(){function c(){var c=[],d,e;for(e in a)e=a[e],d=b[e],d()&&c.push(e);return c}var a=["localstore","sessionstore","memstore"],b={localstore:function(){return typeof window.localStorage!="undefined"},sessionstore:function(){return typeof window.sessionStorage!="undefined"},memstore:function(){return!0}};p.supportedStorageStrategies=c}()})();