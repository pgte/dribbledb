/* dribbledb: simple syncing in javascript
 *
 * copyright 2011 nuno job <nunojob.com> (oO)--',--
 *
 * licensed under the apache license, version 2.0 (the "license");
 * you may not use this file except in compliance with the license.
 * you may obtain a copy of the license at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * unless required by applicable law or agreed to in writing, software
 * distributed under the license is distributed on an "as is" basis,
 * without warranties or conditions of any kind, either express or implied.
 * see the license for the specific language governing permissions and
 * limitations under the license.
 *
 * VERSION: 0.1.0
 * BUILD DATE: Wed Nov 16 19:10:20 2011 +0000
 *//**
 * Slice reference.
 */function EventEmitter(){this.callbacks={}}var slice=[].slice;EventEmitter.prototype.on=function(a,b){return(this.callbacks[a]=this.callbacks[a]||[]).push(b),this},EventEmitter.prototype.emit=function(a){var b=slice.call(arguments,1),c=this.callbacks[a],d;if(c&&c.length>0)for(d=0,len=c.length;d<len;++d)c[d](b);else if("error"===a)throw b[0]||new Error("Unspecified error");return this};var superagent=function(a){function c(){if(window.XMLHttpRequest&&("file:"!==window.location.protocol||!window.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(b){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(c){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(d){}return!1}function e(a){return"function"==typeof a}function f(a){if(null===a)return!1;var b=a.constructor;return b&&Object===b}function g(a){var b;if(!f(a))return a;var c=[];for(b in a)a.hasOwnProperty(b)&&c.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));return c.join("&")}function h(a){var b={},c=a.split("&"),d,e,f;for(f=0,len=c.length;f<len;++f)e=c[f],d=e.split("="),b[decodeURIComponent(d[0])]=decodeURIComponent(d[1]);return b}function i(a){var b=a.split(/\r?\n/),c={},e,f,g,h,i;b.pop();for(i=0,len=b.length;i<len;++i)f=b[i],e=f.indexOf(":"),g=f.slice(0,e).toLowerCase(),h=d(f.slice(e+1)),c[g]=h;return c}function j(a,b){b=b||{},this.xhr=a,this.text=a.responseText,this.setStatusProperties(a.status),this.header=i(a.getAllResponseHeaders()),this.setHeaderProperties(this.header),this.body=this.parseBody(this.text)}function k(a,b){var c=this;EventEmitter.call(this),this.method=a,this.url=b,this.header={},this.set("X-Requested-With","XMLHttpRequest"),this.on("end",function(){c.callback(new j(c.xhr))})}function l(a,b){return"function"==typeof b?(new k("GET",a)).end(b):1===arguments.length?new k("GET",a):new k(a,b)}a=l,a.version="0.1.1";var b=function(){},d="".trim?function(a){return a.trim()}:function(a){return a.replace(/(^\s*|\s*$)/g,"")};return a.serializeObject=g,a.parseString=h,a.types={html:"text/html",json:"application/json",urlencoded:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"},a.serialize={"application/x-www-form-urlencoded":g,"application/json":JSON.stringify},a.parse={"application/x-www-form-urlencoded":h,"application/json":JSON.parse},j.prototype.setHeaderProperties=function(a){var b=(this.header["content-type"]||"").split(/ *; */);this.contentType=b.shift(),this.setParams(b)},j.prototype.setParams=function(a){var b,c;for(c=0,len=a.length;c<len;++c)b=a[c].split(/ *= */),this[b[0]]=b[1]},j.prototype.parseBody=function(b){var c=a.parse[this.contentType];return c?c(b):null},j.prototype.setStatusProperties=function(a){var b=a/100|0;this.status=a,this.statusType=b,this.info=1===b,this.ok=2===b,this.clientError=4===b,this.serverError=5===b,this.error=4===b||5===b,this.accepted=202===a,this.noContent=204===a||1223===a,this.badRequest=400===a,this.unauthorized=401===a,this.notAcceptable=406===a,this.notFound=404===a},a.Response=j,k.prototype=new EventEmitter,k.prototype.constructor=k,k.prototype.set=function(a,b){var c;if(f(a)){for(c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);return this}return this.header[a.toLowerCase()]=b,this},k.prototype.type=function(b){return this.set("Content-Type",a.types[b]||b),this},k.prototype.data=function(a){var b=f(a),c;if(b&&f(this._data))for(c in a)a.hasOwnProperty(c)&&(this._data[c]=a[c]);else this._data=a;return"GET"===this.method?this:b?this.header["content-type"]?this:(this.type("json"),this):this},k.prototype.send=function(a,b){return e(a)?this.end(a):a?this.data(a).end(b):this.end(),this},k.prototype.end=function(d){var e=this,f=this.xhr=c(),g=this._data||null,h;this.callback=d||b,f.onreadystatechange=function(){4===f.readyState&&e.emit("end")},"GET"===this.method&&null!==g&&(this.url+="?"+a.serializeObject(g),g=null),f.open(this.method,this.url,!0);if("GET"!==this.method&&"HEAD"!==this.method){var i=a.serialize[this.header["content-type"]];i&&(g=i(g))}for(h in this.header)this.header.hasOwnProperty(h)&&f.setRequestHeader(h,this.header[h]);return f.send(g),this},a.Request=k,l.get=function(a,b,c){var d=l("GET",a);return e(b)&&(c=b,b=null),b&&d.data(b),c&&d.end(c),d},l.del=function(a,b){var c=l("DELETE",a);return b&&c.end(b),c},l.post=function(a,b,c){var d=l("POST",a);return b&&d.data(b),c&&d.end(c),d},l.put=function(a,b,c){var d=l("PUT",a);return b&&d.data(b),c&&d.end(c),d},a}({});(function(){function f(){function b(b){var c=a.localStorage.getItem(b);return JSON.parse(c)}function c(b,c){c=JSON.stringify(c),a.localStorage.setItem(b,c)}function d(b){a.localStorage.removeItem(b)}function e(b){var c=a.localStorage,d,e,f=[];for(d=0;d<c.length;d++)e=c.key(d),0===e.indexOf(b)&&f.push(e.slice(b.length+1));return f}if(!a.localStorage)throw new Error("At the moment this only works in modern browsers");return{get:b,put:c,destroy:d,all_keys:e}}function g(a,b){return c+":"+a+":"+b}function h(a,b,c){return c!==undefined&&(b+="/"+c),g(a,b)}function i(a,b){return h("doc",a,b)}function j(a,b){return h("meta",a,b)}function k(a){function f(b){return i(a,b)}function g(b){return j(a,b)}function c(a,b){var c=f(a);e.put(c,b),e.put(g(a),!0)}function h(a){return e.get(f(a))}function k(a){e.destroy(f(a))}function l(){return e.all_keys(g())}var b={},c,d;return d=function(){function a(a){}return a.on=function(){syncEmitter.on.apply(syncEmitter,arguments)},a.emit=function(){syncEmitter.emit.apply(syncEmitter,arguments)},a}(),b.sync=d,b.put=c,b.get=h,b.destroy=k,b.unsynced=l,b}var a=this,b=a.dribbledb,c="dribbledb",d,e;e=f(),d=superagent.request,k.version="0.1.0","function"==typeof define&&define.amd?define("dribbledb",function(){return k}):a.dribbledb=k,fn=k.fn,store=k.store})();