/* dribbledb: simple syncing in javascript
 *
 * copyright 2011 pedro teixeira <metaduck.com> & nuno job <nunojob.com> (oO)--',--
 *
 * licensed under the apache license, version 2.0 (the "license");
 * you may not use this file except in compliance with the license.
 * you may obtain a copy of the license at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * unless required by applicable law or agreed to in writing, software
 * distributed under the license is distributed on an "as is" basis,
 * without warranties or conditions of any kind, either express or implied.
 * see the license for the specific language governing permissions and
 * limitations under the license.
 *
 * VERSION: 0.1.0
 * BUILD DATE: Mon Nov 21 00:38:40 2011 +0000
 */(function(){function b(){this.callbacks={}}function d(a,b,d,e){"function"==typeof arguments[2]&&(e=d,d=undefined),c[a](b).expectResponseType("json").end(e)}function e(a,b){d("get",a,undefined,b)}function f(){function a(a){var b=m.localStorage.getItem(a);return JSON.parse(b)}function b(a,b){b=JSON.stringify(b),m.localStorage.setItem(a,b)}function c(a){m.localStorage.removeItem(a)}function d(b,c,d){var e=m.localStorage,f=0,g;(function h(){function i(){f++,f<e.length?h():d&&d()}g=e.key(f),g&&(0===g.indexOf(b)?c(g.slice(b.length+1),a(g),i):i())})()}function e(a){var b=[];return d(a,function(a,c,d){b.push(a),d()}),b}if(!m.localStorage)throw new Error("At the moment this only works in modern browsers");return{get:a,put:b,destroy:c,all_keys_iterator:d,all_keys:e}}function g(a,b){return o+":"+a+":"+b}function h(a,b,c){return c!==undefined&&(b+="/"+c),g(a,b)}function i(a,b){return h("d",a,b)}function j(a,b){return h("m",a,b)}function k(a){return h("s",a)}function q(a){function g(b){return i(a,b)}function h(b){return j(a,b)}function m(){return k(a)}function n(){return p.all_keys(h())}function o(a,b){p.all_keys_iterator(h(),a,b)}function q(a){var b=m();if(!a)return p.get(b)||0;p.put(b,a)}function r(a,b){arguments.length<2&&(b=a,a=b.id||b._id||l());var c=g(a);return p.put(c,b),p.put(h(a),"p"),a}function s(a,b){var c=g(a);p.put(c,b)}function t(a){return p.get(g(a))}function u(a){p.destroy(g(a)),p.put(h(a),"d")}function v(a){p.destroy(g(a))}var c={},f;return f=function(){function i(b,i){function k(){return!j&&typeof i=="function"?(j=!0,i.apply(c,arguments),!0):!1}function l(a){return a?(k(a)||f.emit("error",a),!0):!1}function m(c,f,g){function n(a,d){if(a)return l(a);if(d.conflict)e(k,function(a,d){if(a)return l(a);b?b(j,d.body,function(a){r(c,a),m(c,f,g)}):(a=new Error("Conflict"),a.key=c,a.mine=j,a.theirs=d.body,l(a))});else{if(!d.ok)return l(new Error(i+" "+k+" failed with response status "+d.status+": "+d.text));p.destroy(h(c)),g()}}var i,j=t(c),k=a+"/"+c;i=f==="p"?"put":f==="d"?"del":undefined;if(!i)throw new Error("Invalid meta action: "+f);d(i,k,j,n)}function n(c){var d=a+"/_changes?since="+q()+"&include_docs=true&force_json=true";e(d,function(a,e){var f,i,j,k,m,n,o,p;if(a)return l(a);if(!e.ok)return c(new Error("Pull response not ok for URI: "+d));if(!e.body)return c(new Error("Pull response does not have body for URI: "+d));i=e.body;if("object"!=typeof i)return c(new Error("Pull response body is not object for URI: "+d));if(!i.hasOwnProperty("last_seq"))return o=new Error("response body does not have .last_seq: "+d),o.body=i,c(o);if(!i.hasOwnProperty("results"))return o=new Error("response body does not have .results: "+d),o.body=i,c(o);j=i.results,f=-1,function u(){f+=1,f<j.length?(k=j[f],m=k.id,n=k.doc,t(h(m))?b?(p=t(g(m)),b(p,n,function(a){r(m,a),u()})):(o=new Error("Conflict"),o.key=m,o.mine=p,o.theirs=n,l(o),u()):(k.deleted?v(m):s(m,n),u())):(q(i.last_seq),c())}()})}var j=!1;arguments.length<2&&(i=b,b=undefined),o(m,function(){n(function(a){if(a)return l(a);k()})})}var f=new b;return i.on=function(){f.on.apply(f,arguments)},i.emit=function(){f.emit.apply(f,arguments)},i}(),c.sync=f,c.put=r,c.get=t,c.destroy=u,c.unsynced_keys=n,c}var a=[].slice;b.prototype.on=function(a,b){return(this.callbacks[a]=this.callbacks[a]||[]).push(b),this},b.prototype.emit=function(b){var c=a.call(arguments,1),d=this.callbacks[b],e;if(d&&d.length>0)for(e=0,len=d.length;e<len;++e)d[e](c);else if("error"===b)throw c[0]||new Error("Unspecified error");return this};var c=function(a){function d(){if(window.XMLHttpRequest&&("file:"!==window.location.protocol||!window.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(b){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(c){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(d){}return!1}function f(a){return"function"==typeof a}function g(a){if(null===a||undefined==a)return!1;var b=a.constructor;return b&&Object===b}function h(a){var b;if(!g(a))return a;var c=[];for(b in a)a.hasOwnProperty(b)&&c.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));return c.join("&")}function i(a){var b={},c=a.split("&"),d,e,f;for(f=0,len=c.length;f<len;++f)e=c[f],d=e.split("="),b[decodeURIComponent(d[0])]=decodeURIComponent(d[1]);return b}function j(a){var b=a.split(/\r?\n/),c={},d,f,g,h,i;b.pop();for(i=0,len=b.length;i<len;++i)f=b[i],d=f.indexOf(":"),g=f.slice(0,d).toLowerCase(),h=e(f.slice(d+1)),c[g]=h;return c}function k(a,b){b=b||{},this.options=b,this.xhr=a,this.text=a.responseText,this.setStatusProperties(a.status),this.header=j(a.getAllResponseHeaders()),this.setHeaderProperties(this.header),this.body=this.parseBody(this.text)}function l(a,c){var d=this;b.call(this),this.method=a,this.url=c,this.header={},this.set("X-Requested-With","XMLHttpRequest"),this.on("end",function(){var a=new k(d.xhr,{expectResponseType:d._expectResponseType}),b;a.status===0&&(b=new Error("Unknown XHR Error")),d.callback(b,a)})}function m(a,b){return"function"==typeof b?(new l("GET",a)).end(b):1===arguments.length?new l("GET",a):new l(a,b)}a=m,a.version="0.1.1";var c=function(){},e="".trim?function(a){return a.trim()}:function(a){return a.replace(/(^\s*|\s*$)/g,"")};return a.serializeObject=h,a.parseString=i,a.types={html:"text/html",json:"application/json",urlencoded:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"},a.serialize={"application/x-www-form-urlencoded":h,"application/json":JSON.stringify},a.parse={"application/x-www-form-urlencoded":i,"application/json":JSON.parse},k.prototype.setHeaderProperties=function(a){var b=(this.header["content-type"]||"").split(/ *; */);this.contentType=b.shift(),this.setParams(b)},k.prototype.setParams=function(a){var b,c;for(c=0,len=a.length;c<len;++c)b=a[c].split(/ *= */),this[b[0]]=b[1]},k.prototype.parseBody=function(b){var c=a.parse[this.options.expectResponseType||this.contentType];return c?c(b):null},k.prototype.setStatusProperties=function(a){var b=a/100|0;this.status=a,this.statusType=b,this.info=1===b,this.ok=2===b,this.clientError=4===b,this.serverError=5===b,this.error=4===b||5===b,this.accepted=202===a,this.noContent=204===a||1223===a,this.badRequest=400===a,this.unauthorized=401===a,this.notFound=404===a,this.notAcceptable=406===a,this.conflict=409===a},a.Response=k,l.prototype=new b,l.prototype.constructor=l,l.prototype.set=function(a,b){var c;if(g(a)){for(c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);return this}return this.header[a.toLowerCase()]=b,this},l.prototype.expectResponseType=function(b){return this._expectResponseType=a.types[b]||b,this},l.prototype.type=function(b){return this.set("Content-Type",a.types[b]||b),this},l.prototype.data=function(a){var b=g(a),c;if(b&&g(this._data))for(c in a)a.hasOwnProperty(c)&&(this._data[c]=a[c]);else this._data=a;return"GET"===this.method?this:b?this.header["content-type"]?this:(this.type("json"),this):this},l.prototype.send=function(a,b){return f(a)?this.end(a):a?this.data(a).end(b):this.end(),this},l.prototype.end=function(b){var e=this,f=this.xhr=d(),g=this._data||null,h;this.callback=b||c,f.onreadystatechange=function(){4===f.readyState&&e.emit("end")},"GET"===this.method&&null!==g&&(this.url+="?"+a.serializeObject(g),g=null),f.open(this.method,this.url,!0);if("GET"!==this.method&&"HEAD"!==this.method){var i=a.serialize[this.header["content-type"]];i&&(g=i(g))}for(h in this.header)this.header.hasOwnProperty(h)&&f.setRequestHeader(h,this.header[h]);return f.send(g),this},a.Request=l,m.get=function(a,b,c){var d=m("GET",a);return f(b)&&(c=b,b=null),b&&d.data(b),c&&d.end(c),d},m.del=function(a,b){var c=m("DELETE",a);return b&&c.end(b),c},m.post=function(a,b,c){var d=m("POST",a);return b&&d.data(b),c&&d.end(c),d},m.put=function(a,b,c){var d=m("PUT",a);return b&&d.data(b),c&&d.end(c),d},a}({}),l=function(){function h(a){var b=new c(16),d=0;return a.toLowerCase().replace(/[0-9a-f][0-9a-f]/g,function(a){b[d++]=f[a]}),b}function i(a){var b=e,c=a;return b[c[0]]+b[c[1]]+b[c[2]]+b[c[3]]+"-"+b[c[4]]+b[c[5]]+"-"+b[c[6]]+b[c[7]]+"-"+b[c[8]]+b[c[9]]+"-"+b[c[10]]+b[c[11]]+b[c[12]]+b[c[13]]+b[c[14]]+b[c[15]]}function q(e,f,g){typeof e=="string"&&(e={format:e}),e=e||{};var h=e.format!="binary"?d:f?f:new c(16),k=f&&g||0,l=(e.timestamp!==undefined?e.timestamp:(new Date).getTime())+a;p=l===o?p+1:0,p=e.count||p;if(l<o||p>b)n++,p=0;o=l;var q=l,r=((q&268435455)*1e4+p)%4294967296,s=q/4294967296*1e4&268435455,t=s&65535,u=s>>16,v=u&4095|4096;n=e.clockseq!==undefined?e.clockseq:n;var w=n&255,x=n>>>8|128;h[k++]=r>>>24&j,h[k++]=r>>>16&j,h[k++]=r>>>8&j,h[k++]=r&j,h[k++]=t>>>8&j,h[k++]=t&j,h[k++]=v>>>8&j,h[k++]=v&j,h[k++]=x,h[k++]=w,m=e.node||m;var y=0;return h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],e.format===undefined?i(h):h}function r(a,b,e){typeof a=="string"&&(a={format:a}),a=a||{};var f=a.format!="binary"?d:b?b:new c(16),g=b&&e||0;a.random?l=a.random:k?crypto.getRandomValues(l):(l[0]=Math.random()*4294967296,l[1]=Math.random()*4294967296,l[2]=Math.random()*4294967296,l[3]=Math.random()*4294967296);var h=l[0];return f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,h=l[1],f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&15|64,f[g++]=h>>>24&j,h=l[2],f[g++]=h&63|128,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,h=l[3],f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,a.format===undefined?i(f):f}var a=122192928e5,b=1e4,c=typeof Buffer=="function"?Buffer:Array,d=new c(16),e=[],f={};for(var g=0;g<256;g++)e[g]=(g+256).toString(16).substr(1),f[e[g]]=g;var j=255,k=this.crypto&&crypto.getRandomValues,l=k?new Uint32Array(4):Array(4);k?crypto.getRandomValues(l):(l[0]=Math.random()*4294967296,l[1]=Math.random()*4294967296,l[2]=Math.random()*4294967296);var m=[l[0]&j|1,l[0]>>>8&j,l[0]>>>16&j,l[0]>>>24&j,l[1]&j,l[1]>>>8&j],n=l[2]&16383,o=0,p=0,s=r;s.v1=q,s.v4=r,s.parse=h,s.unparse=i,s.BufferClass=c;if(typeof module!="undefined")module.exports=s;else return s}().v4,m=this,n=m.dribbledb,o="dbd",p=f();q.version="0.1.0","function"==typeof define&&define.amd?define("dribbledb",function(){return q}):m.dribbledb=q,fn=q.fn,f=q.store})();