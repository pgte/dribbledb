/* dribbledb: simple syncing in javascript
 *
 * copyright 2011 pedro teixeira <metaduck.com> & nuno job <nunojob.com> (oO)--',--
 *
 * licensed under the apache license, version 2.0 (the "license");
 * you may not use this file except in compliance with the license.
 * you may obtain a copy of the license at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * unless required by applicable law or agreed to in writing, software
 * distributed under the license is distributed on an "as is" basis,
 * without warranties or conditions of any kind, either express or implied.
 * see the license for the specific language governing permissions and
 * limitations under the license.
 *
 * VERSION: 0.1.0
 * BUILD DATE: Fri Nov 25 11:04:26 2011 +0000
 */(function(){function b(){this.callbacks={}}function d(){}function e(a,b,d,e){"function"==typeof arguments[2]&&(e=d,d=undefined),c[a](b,d).type("application/javascript").expectResponseType("json").end(e)}function f(a,b){e("get",a,undefined,b)}function k(a,c){function i(a,b){var c=a;return b!==undefined&&(c+="/"+b),c}function n(a){return function(b){function d(a,b){return c.get(k,a,b)}function e(a,b,d){return c.put(k,a,b,d)}function f(a,b){return c.destroy(k,a,b)}function g(a,b){return c.get(l,a,b)}function h(a,b,d){return c.put(l,a,b,d)}function i(a,b){return c.destroy(l,a,b)}function j(a,b){return c.all_keys_iterator(k,a,b)}function n(a){return c.all_keys(k,a)}function o(a,b){return c.all_keys_iterator(l,a,b)}function p(a){return c.all_keys(l,a)}function q(a,b){if("function"!=typeof b)throw new Error("2nd argument must be a function");if(!a)c.get(m,undefined,function(a,c){if(a)return b(a);b(null,c||0)});else return c.put(m,undefined,a,b)}var c=a(b);return{stratName:c.stratName,doc:{get:d,put:e,destroy:f,all_keys_iterator:j,all_keys:n},meta:{get:g,put:h,destroy:i,all_keys_iterator:o,all_keys:p},pulled_since:q}}}function o(a){function f(a,b){e[a].get(b)}function g(a,b,c){e[a].add(c,b)}function h(a,b){e[a].delete(b)}function i(a,b,c){function f(){cursor.continue()?(d=cursor.value,b(d.id,d,f)):c()}var d;e[a].openCursor()}function k(a){var b=[];return browser_all_keys_iterator(a,function(a,c,d){b.push(a),d()}),b}var b=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,c=b.open(j),d=["d","m","s"],e={};return function(){var b;for(var f in d)b=d[f],e[b]=c.createObjectStore(b+":"+a)}(),{get:f,put:g,destroy:h,all_keys_iterator:i,all_keys:k,stratName:"idbstore"}}function p(a,b,c){function e(b,c){if(b.length!=1)throw new Error("Invalid prefix: "+b);var d=j+":"+b+":"+a;return"undefined"!=typeof c&&(d+="/"+c),d}function f(a,c,d){if("function"!=typeof d)throw new Error("3rd argument must be a function");var f=b.getItem(e(a,c));d(null,JSON.parse(f))}function g(a,c,d,f){if("function"!=typeof f)throw new Error("3rd argument must be a function");var g=e(a,c),h=JSON.stringify(d);b.setItem(g,h),f()}function h(a,c,d){if("function"!=typeof d)throw new Error("3rd argument must be a function");var f=e(a,c);return null!==b.getItem(f)?(b.removeItem(f),d(null,!0)):d(null,!1)}function i(a,c,g){var h=b,i,j=0,k=e(a);g=g||d,i=function(){var a,b,c=[];for(b=0;b<h.length;b++)a=h.key(b),a&&0===a.indexOf(k)&&c.push(a);return c}(),function l(){function e(){j++,l()}var b,d;if(j<i.length)b=i[j],d=b.slice(k.length+1),f(a,d,function(a,b){if(a)return g(a);c(d,b,e)});else return g()}()}function k(a,b){var c=[];i(a,function(a,b,d){c.push(a),d()},function(a){if(a)return b(a);b(null,c)})}if(!b)throw new Error("At the moment this only works in modern browsers");return{get:f,put:g,destroy:h,all_keys_iterator:i,all_keys:k,stratName:c}}function q(a){return p(a,h.localStorage,"localstore")}function r(a){return p(a,h.sessionStorage,"sessionstore")}function s(a){function c(b,c){if(b.length>1)throw new Error("Invalid prefix: "+b);var d=j+":"+b+":"+a;return"undefined"!=typeof c&&(d+="/"+c),d}function e(a){return JSON.parse(JSON.stringify(a))}function f(a,d,f){var g=b[c(a,d)],h=null;"undefined"!=typeof g&&(h=e(g)),f(null,h)}function g(a,d,f,g){b[c(a,d)]=e(f),g(null,d)}function h(a,d,e){delete b[c(a,d)],e(null)}function i(a,e,g){var h=b,i,j=0,k=c(a);g=g||d,i=function(){var a,c=[];for(a in b)a&&0===a.indexOf(k)&&c.push(a);return c}(),function l(){function b(){j++,l()}var a;if(j<i.length)a=i[j],e(a.slice(k.length+1),f(a),b);else return g()}()}function k(a,b){var c=[];i(a,function(a,b,d){c.push(a),d()}),b(null,c)}var b={};return{get:f,put:g,destroy:h,all_keys_iterator:i,all_keys:k,stratName:"memstore"}}function t(a){var b={idbstore:o,localstore:q,sessionstore:r,memstore:s};return n(b[a])}function u(a){var b;if("function"==typeof a)b=a;else switch(a){case"couchdb_bulk":b=v;break;default:throw new Error("Unknown pull strategy: "+a)}return b}function v(){return function(b,c){var d=!1;F(function(d,e){if(d)return c(d);var g=a+"/_changes?since="+e+"&include_docs=true";f(g,function(a,d){var e,f,h,i,j,k,l,m;if(a)return c(a);if(!d.ok)return c(new Error("Pull response not ok for URI: "+g));if(!d.body)return c(new Error("Pull response does not have body for URI: "+g));f=d.body;if("object"!=typeof f)return c(new Error("Pull response body is not object for URI: "+g));if(!f.hasOwnProperty("last_seq"))return l=new Error("response body does not have .last_seq: "+g),l.body=f,c(l);if(!f.hasOwnProperty("results"))return l=new Error("response body does not have .results: "+g),l.body=f,c(l);h=f.results,e=-1,function n(){e+=1,e<h.length?(i=h[e],j=i.id,k=i.doc,A.meta.get(j,function(a,d){if(a)return c(a);if(d)if(b)A.doc_get(j,function(a,d){if(a)return c(a);b(d,k,function(a){H(j,a,c),n()})});else return l=new Error("Conflict"),l.key=j,l.mine=m,l.theirs=k,c(l);else i.deleted?L(j):I(j,k,function(a){if(a)return c(a);n()})})):F(f.last_seq,c)}()})})}}function w(a){var b;if("function"==typeof a)b=a;else switch(a){case"restful_ajax":b=x;break;default:throw new Error("Unknown push strategy: "+a)}return b}function x(){return function(b,c){function g(d,h,i){var j,k=h.charAt(0),l=h.substr(1),m=a+"/"+d;j=k==="p"?"put":k==="d"?"del":undefined;if(!j)throw new Error("Invalid meta action: "+h);l&&(m+="?rev="+l),J(d,function(a,k){function l(a,e){if(a)return c(a);if(e.conflict)f(m,function(a,e){if(a)return c(a);if(b)b(k,e.body,function(a){H(d,a),g(d,h,i)});else return a=new Error("Conflict"),a.key=d,a.mine=k,a.theirs=e.body,c(a)});else{if(("del"!==j||!e.notFound)&&!e.ok)return c(new Error(j+" "+m+" failed with response status "+e.status+": "+e.text));A.meta.destroy(d,function(a){if(a)return c(a);i()})}}e(j,m,k,l)})}var d=!1;E(g,c)}}function D(a){return A.meta.all_keys(a)}function E(a,b){A.meta.all_keys_iterator(a,b)}function F(a,b){return arguments.length<2&&(b=a,a=undefined),A.pulled_since(a,b)}function G(a){a&&y.emit("error",a)}function H(a,b,c){arguments.length<3&&("function"==typeof b?(c=b,b=a,a=b.id||b._id||g()):c=G);if(!b.id||b._id)b._id=a;return A.doc.put(a,b,function(b){if(b)return c(b);A.meta.put(a,"p",function(b){if(b)return c(b);c(null,a)})}),a}function I(a,b,c){return c||(c=G),A.doc.put(a,b,c)}function J(a,b){return b||(b=G),A.doc.get(a,b)}function K(a,b){var c="d";J(a,function(d,e){if(d)return b(d);e&&e._rev&&(c+=e._rev),A.doc.destroy(a,function(d,e){if(d)return b(d);e?A.meta.put(a,c,b):b()})})}function L(a,b){A.doc.destroy(a,b)}function M(a){function c(a,c,d){b.push(c),d()}function d(c){if(c)return a(c);a(null,b)}var b=[];A.doc.all_keys_iterator(c,d)}function N(a){(function(b){A.doc.all_keys(function(c,d){if(c)return a(c);var e,f=-1;(function g(){f+=1;if(f<d.length)e=d[f],A.doc.destroy(e,function(b){if(b)return a(b);g()});else return b()})()})})(function(){A.meta.all_keys(function(b,c){if(b)return a(b);var d,e=-1;(function f(){e+=1;if(e<c.length)d=c[e],A.meta.destroy(d,function(b){if(b)return a(b);f()});else return a()})()})})}function O(a,b){B(a,b)}function P(a,b){C(a,b)}var k="d",l="m",m="s",y=new b,z,A,B,C;return c=c||{},c.storage_strategy||(c.storage_strategy="localstore"),A=t(c.storage_strategy)(a),c.pull_strategy||(c.pull_strategy="couchdb_bulk"),B=u(c.pull_strategy)(),c.push_strategy||(c.push_strategy="restful_ajax"),C=w(c.push_strategy)(),z=function(){function c(b,c){function e(){return!d&&typeof c=="function"?(d=!0,c.apply(y,arguments),!0):!1}function f(b){b&&!e(b)&&a.emit("error",b)}var d=!1;arguments.length<2&&(c=b,b=undefined),P(b,function(a){if(a)return f(a);O(b,function(a){if(a)return f(a);e()})})}var a=new b;return c.on=function(){a.on.apply(a,arguments)},c}(),y.storageStrategy=A.stratName,y.sync=z,y.put=H,y.get=J,y.destroy=K,y.unsynced_keys=D,y.all=M,y.nuke=N,y}var a=[].slice;b.prototype.on=function(a,b){return(this.callbacks[a]=this.callbacks[a]||[]).push(b),this},b.prototype.emit=function(b){var c=a.call(arguments,1),d=this.callbacks[b],e,f;if(d&&d.length>0)for(e=0,f=d.length;e<f;++e)d[e](c);else if("error"===b)throw c[0]||new Error("Unspecified error");return this};var c=function(a){function d(){if(window.XMLHttpRequest&&("file:"!==window.location.protocol||!window.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(b){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(c){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(d){}return!1}function f(a){return"function"==typeof a}function g(a){if(null===a||undefined==a)return!1;var b=a.constructor;return b&&Object===b}function h(a){var b;if(!g(a))return a;var c=[];for(b in a)a.hasOwnProperty(b)&&c.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));return c.join("&")}function i(a){var b={},c=a.split("&"),d,e,f,g;for(f=0,g=c.length;f<g;++f)e=c[f],d=e.split("="),b[decodeURIComponent(d[0])]=decodeURIComponent(d[1]);return b}function j(a){var b=a.split(/\r?\n/),c={},d,f,g,h,i,j;b.pop();for(i=0,j=b.length;i<j;++i)f=b[i],d=f.indexOf(":"),g=f.slice(0,d).toLowerCase(),h=e(f.slice(d+1)),c[g]=h;return c}function k(a,b){b=b||{},this.options=b,this.xhr=a,this.text=a.responseText,this.setStatusProperties(a.status),this.header=j(a.getAllResponseHeaders()),this.setHeaderProperties(this.header),this.body=this.parseBody(this.text)}function l(a,c){var d=this;b.call(this),this.method=a,this.url=c,this.header={},this.set("X-Requested-With","XMLHttpRequest"),this.on("end",function(){var a=new k(d.xhr,{expectResponseType:d._expectResponseType}),b;a.status===0&&(b=new Error("Unknown XHR Error")),d.callback(b,a)})}function m(a,b){return"function"==typeof b?(new l("GET",a)).end(b):1===arguments.length?new l("GET",a):new l(a,b)}a=m,a.version="0.1.1";var c=function(){},e="".trim?function(a){return a.trim()}:function(a){return a.replace(/(^\s*|\s*$)/g,"")};return a.serializeObject=h,a.parseString=i,a.types={html:"text/html",json:"application/json",urlencoded:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"},a.serialize={"application/x-www-form-urlencoded":h,"application/json":JSON.stringify},a.parse={"application/x-www-form-urlencoded":i,"application/json":JSON.parse},k.prototype.setHeaderProperties=function(a){var b=(this.header["content-type"]||"").split(/ *; */);this.contentType=b.shift(),this.setParams(b)},k.prototype.setParams=function(a){var b,c,d;for(c=0,d=a.length;c<d;++c)b=a[c].split(/ *= */),this[b[0]]=b[1]},k.prototype.parseBody=function(b){var c=a.parse[this.ok&&this.options.expectResponseType||this.contentType];return c?c(b):null},k.prototype.setStatusProperties=function(a){var b=a/100|0;this.status=a,this.statusType=b,this.info=1===b,this.ok=2===b,this.clientError=4===b,this.serverError=5===b,this.error=4===b||5===b,this.accepted=202===a,this.noContent=204===a||1223===a,this.badRequest=400===a,this.unauthorized=401===a,this.notFound=404===a,this.notAcceptable=406===a,this.conflict=409===a},a.Response=k,l.prototype=new b,l.prototype.constructor=l,l.prototype.set=function(a,b){var c;if(g(a)){for(c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);return this}return this.header[a.toLowerCase()]=b,this},l.prototype.expectResponseType=function(b){return this._expectResponseType=a.types[b]||b,this},l.prototype.type=function(b){return this.set("Content-Type",a.types[b]||b),this},l.prototype.data=function(a){var b=g(a),c;if(b&&g(this._data))for(c in a)a.hasOwnProperty(c)&&(this._data[c]=a[c]);else this._data=a;return"GET"===this.method?this:b?this.header["content-type"]?this:(this.type("json"),this):this},l.prototype.send=function(a,b){return f(a)?this.end(a):a?this.data(a).end(b):this.end(),this},l.prototype.end=function(b){var e=this,f=this.xhr=d(),g=this._data||null,h;this.callback=b||c,f.onreadystatechange=function(){4===f.readyState&&e.emit("end")},"GET"===this.method&&null!==g&&(this.url+="?"+a.serializeObject(g),g=null),f.open(this.method,this.url,!0);if("GET"!==this.method&&"HEAD"!==this.method){var i=a.serialize[this.header["content-type"]];i&&(g=i(g))}for(h in this.header)this.header.hasOwnProperty(h)&&f.setRequestHeader(h,this.header[h]);return f.send(g),this},a.Request=l,m.get=function(a,b,c){var d=m("GET",a);return f(b)&&(c=b,b=null),b&&d.data(b),c&&d.end(c),d},m.del=function(a,b){var c=m("DELETE",a);return b&&c.end(b),c},m.post=function(a,b,c){var d=m("POST",a);return b&&d.data(b),c&&d.end(c),d},m.put=function(a,b,c){var d=m("PUT",a);return b&&d.data(b),c&&d.end(c),d},a}({}),g=function(){function h(a){var b=new c(16),d=0;return a.toLowerCase().replace(/[0-9a-f][0-9a-f]/g,function(a){b[d++]=f[a]}),b}function i(a){var b=e,c=a;return b[c[0]]+b[c[1]]+b[c[2]]+b[c[3]]+"-"+b[c[4]]+b[c[5]]+"-"+b[c[6]]+b[c[7]]+"-"+b[c[8]]+b[c[9]]+"-"+b[c[10]]+b[c[11]]+b[c[12]]+b[c[13]]+b[c[14]]+b[c[15]]}function q(e,f,g){typeof e=="string"&&(e={format:e}),e=e||{};var h=e.format!="binary"?d:f?f:new c(16),k=f&&g||0,l=(e.timestamp!==undefined?e.timestamp:(new Date).getTime())+a;p=l===o?p+1:0,p=e.count||p;if(l<o||p>b)n++,p=0;o=l;var q=l,r=((q&268435455)*1e4+p)%4294967296,s=q/4294967296*1e4&268435455,t=s&65535,u=s>>16,v=u&4095|4096;n=e.clockseq!==undefined?e.clockseq:n;var w=n&255,x=n>>>8|128;h[k++]=r>>>24&j,h[k++]=r>>>16&j,h[k++]=r>>>8&j,h[k++]=r&j,h[k++]=t>>>8&j,h[k++]=t&j,h[k++]=v>>>8&j,h[k++]=v&j,h[k++]=x,h[k++]=w,m=e.node||m;var y=0;return h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],h[k++]=m[y++],e.format===undefined?i(h):h}function r(a,b,e){typeof a=="string"&&(a={format:a}),a=a||{};var f=a.format!="binary"?d:b?b:new c(16),g=b&&e||0;a.random?l=a.random:k?crypto.getRandomValues(l):(l[0]=Math.random()*4294967296,l[1]=Math.random()*4294967296,l[2]=Math.random()*4294967296,l[3]=Math.random()*4294967296);var h=l[0];return f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,h=l[1],f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&15|64,f[g++]=h>>>24&j,h=l[2],f[g++]=h&63|128,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,h=l[3],f[g++]=h&j,f[g++]=h>>>8&j,f[g++]=h>>>16&j,f[g++]=h>>>24&j,a.format===undefined?i(f):f}var a=122192928e5,b=1e4,c=typeof Buffer=="function"?Buffer:Array,d=new c(16),e=[],f={};for(var g=0;g<256;g++)e[g]=(g+256).toString(16).substr(1),f[e[g]]=g;var j=255,k=this.crypto&&crypto.getRandomValues,l=k?new Uint32Array(4):Array(4);k?crypto.getRandomValues(l):(l[0]=Math.random()*4294967296,l[1]=Math.random()*4294967296,l[2]=Math.random()*4294967296);var m=[l[0]&j|1,l[0]>>>8&j,l[0]>>>16&j,l[0]>>>24&j,l[1]&j,l[1]>>>8&j],n=l[2]&16383,o=0,p=0,s=r;s.v1=q,s.v4=r,s.parse=h,s.unparse=i,s.BufferClass=c;if(typeof module!="undefined")module.exports=s;else return s}().v4,h=this,i=h.dribbledb,j="dbd";k.version="0.1.0","function"==typeof define&&define.amd?define("dribbledb",function(){return k}):h.dribbledb=k,function(){function c(){var c=[],d,e;for(e in a)e=a[e],d=b[e],d()&&c.push(e);return c}var a=["idbstore","localstore","sessionstore","memstore"],b={idbstore:function(){return"undefined"!=typeof (window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB)},localstore:function(){return typeof window.localStorage!="undefined"},sessionstore:function(){return typeof window.sessionStorage!="undefined"},memstore:function(){return!0}};k.supportedStorageStrategies=c}()})();